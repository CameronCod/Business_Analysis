<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Booking Insight</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* ADDED STYLES FOR CHATBOT WIDGET */
        .result-box.info {
            background-color: #f0f7ff;
            border-color: #3399ff;
            color: #3399ff;
        }

        .prediction-tool textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            resize: vertical;
        }

        /* Chatbot Container Styles */
        .chatbot-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            max-height: 500px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background-color: #007bff;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
        }

        .chat-window {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            max-height: 350px;
            border-bottom: 1px solid #eee;
        }

        .chat-input {
            padding: 10px 15px;
            display: flex;
        }

        .chat-input input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px 0 0 4px;
            outline: none;
        }

        .chat-input button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .chat-input button:hover {
            background-color: #1e7e34;
        }

        /* Chat Messages */
        .chat-message {
            margin-bottom: 10px;
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 15px;
            line-height: 1.4;
        }

        .user-message {
            background-color: #e6f7ff;
            color: #333;
            margin-left: auto;
            border-bottom-right-radius: 2px;
        }

        .bot-message {
            background-color: #f8f9fa;
            color: #333;
            margin-right: auto;
            border-bottom-left-radius: 2px;
        }
    </style>
</head>

<body>
    <header>
        <h1>Hotel Booking Insight Dashboard</h1>
        <p>A data analysis and prediction tool built with Python (Flask) and your hotel booking data.</p>
    </header>

    <div class="container">
        <section class="dashboard-grid">
            <h2>Data Summary</h2>

            <div class="card bg-blue">
                <h3>Total Bookings Analyzed</h3>
                <p>{{ data.total_bookings | default('N/A') }}</p>
            </div>
            <div class="card bg-red">
                <h3>Overall Cancellation Rate</h3>
                <p>{{ data.cancellation_rate | default('N/A') }}%</p>
            </div>
            <div class="card bg-green">
                <h3>Model Accuracy</h3>
                <p>{{ data.model_accuracy | default('N/A') }}%</p>
            </div>
            <div class="card full-width">
                <h3>Hotel Type Distribution</h3>
                {% for hotel, count in data.hotel_type_counts.items() %}
                <p><strong>{{ hotel }}:</strong> {{ count }} bookings</p>
                {% endfor %}
            </div>
            <div class="card">
                <h3>Avg Daily Rate (ADR)</h3>
                <p><strong>City Hotel:</strong> ${{ data.avg_adr_city | default('N/A') }}</p>
                <p><strong>Resort Hotel:</strong> ${{ data.avg_adr_resort | default('N/A') }}</p>
            </div>
            <div class="card">
                <h3>Top 5 Booking Countries</h3>
                <ol>
                    {% for country, count in data.top_countries.items() %}
                    <li>{{ country }} ({{ count }})</li>
                    {% endfor %}
                </ol>
            </div>
        </section>

        <hr>

        <section class="prediction-tool">
            <h2>Booking Cancellation Predictor</h2>
            <form action="/predict" method="post" class="prediction-form">
                <label for="lead_time">Lead Time (Days before arrival):</label>
                <input type="number" id="lead_time" name="lead_time" min="0" required value="50">
                <label for="deposit_type">Deposit Type:</label>
                <select id="deposit_type" name="deposit_type" required>
                    <option value="No Deposit">No Deposit</option>
                    <option value="Non Refund">Non Refund</option>
                    <option value="Refundable">Refundable</option>
                </select>
                <label for="is_repeated_guest">Is Repeated Guest:</label>
                <select id="is_repeated_guest" name="is_repeated_guest" required>
                    <option value="no">No</option>
                    <option value="yes">Yes</option>
                </select>
                <label for="previous_cancellations">Previous Cancellations:</label>
                <input type="number" id="previous_cancellations" name="previous_cancellations" min="0" required
                    value="0">
                <button type="submit">Predict Cancellation</button>
            </form>
            {% if prediction_result and not sentiment_result %}
            <div class="result-box {{ prediction_result.class }}">
                <h3>Prediction Result</h3>
                <p class="result-text">{{ prediction_result.text | safe }}</p>
                <p class="result-prob">Cancellation Probability: <strong>{{ prediction_result.probability }}%</strong>
                </p>
            </div>
            {% endif %}
        </section>

        <hr>

        <section class="prediction-tool">
            <h2>Guest Feedback Sentiment Analyzer</h2>
            <p>Paste customer feedback below to determine its underlying sentiment.</p>
            <form action="/sentiment" method="post" class="sentiment-form">
                <label for="feedback_text">Guest Feedback:</label>
                <textarea id="feedback_text" name="feedback_text" required
                    placeholder="Example: The check-in was smooth, but the room service was terrible."></textarea>
                <button type="submit">Analyze Sentiment</button>
            </form>
            {% if sentiment_result %}
            <div class="result-box {{ sentiment_result.class }}">
                <h3>Sentiment Analysis Result</h3>
                <p class="result-text">{{ sentiment_result.text | safe }}</p>
                <p>Compound Score: <strong>{{ sentiment_result.score }}</strong> (Range: -1.0 to +1.0)</p>
                {% if sentiment_result.feedback %}
                <p class="result-prob">**Feedback Analyzed:** <em>"{{ sentiment_result.feedback }}"</em></p>
                {% endif %}
            </div>
            {% endif %}
        </section>

    </div>

    <footer>
        <p>&copy; Hotel Insight Solution. Data powered by hotel_bookings.csv.</p>
    </footer>

    <div class="chatbot-container">
        <div class="chat-header" onclick="toggleChat()">
            ðŸ“Š Data Insight Chatbot
        </div>
        <div class="chat-content" style="display: block;">
            <div class="chat-window" id="chat-window">
                <div class="chat-message bot-message">Hello! I'm the Hotel Data Bot. I can answer questions about
                    **cancellation rate**, **ADR**, or **top countries** from the dataset.</div>
            </div>
            <div class="chat-input">
                <input type="text" id="chat-input-field" placeholder="Ask a data question..."
                    onkeypress="if(event.key === 'Enter') sendMessage()">
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        function toggleChat() {
            const content = document.querySelector('.chat-content');
            content.style.display = content.style.display === 'none' ? 'flex' : 'none';
        }

        function sendMessage() {
            const inputField = document.getElementById('chat-input-field');
            const message = inputField.value.trim();
            if (message === '') return;

            const chatWindow = document.getElementById('chat-window');

            // 1. Add user message to chat window
            const userDiv = document.createElement('div');
            userDiv.className = 'chat-message user-message';
            userDiv.innerHTML = message;
            chatWindow.appendChild(userDiv);

            // Scroll to bottom
            chatWindow.scrollTop = chatWindow.scrollHeight;

            // Clear input
            inputField.value = '';

            // 2. Send message to Flask backend
            fetch('/chatbot', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message }),
            })
                .then(response => response.json())
                .then(data => {
                    // 3. Add bot response to chat window
                    const botDiv = document.createElement('div');
                    botDiv.className = 'chat-message bot-message';
                    // Use a temporary div to render markdown bold/italic
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = data.response.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    botDiv.innerHTML = tempDiv.innerHTML;

                    chatWindow.appendChild(botDiv);

                    // Scroll to bottom after bot reply
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                })
                .catch(error => {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'chat-message bot-message';
                    errorDiv.innerHTML = 'Sorry, an error occurred communicating with the data API.';
                    chatWindow.appendChild(errorDiv);
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                    console.error('Error:', error);
                });
        }
    </script>
</body>

</html>